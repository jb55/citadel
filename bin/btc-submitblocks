#!/usr/bin/env bash

set -eou pipefail

mkdir -p /tmp/blocks

nncp-toss

blocks=$(bitcoin-cli getblockcount)

cd /tmp/blocks
blocklist=$(ls -1 | sort -n)
to_submit=$(wc -l <<<"$blocklist")
printf "%d blocks to submit...\n" "$to_submit" >&2 

for block in $blocklist
do
	printf "submitting block $block ... " >&2

	res=$(<$block bitcoin-cli -stdin submitblock)

	printf "$res\n" >&2

	if [ "$res" = "prev-blk-not-found" ]; then
		exit 42
	fi
done

blocks2=$(bitcoin-cli getblockcount)

printf "%d to height %d, processed %d blocks\n" $blocks $blocks2 $(bc <<<"$blocks2 - $blocks")

rm -rf /tmp/blocks/*
