#!/usr/bin/env bash
# Transfer PDF/EPUB file(s) to a reMarkable

set -euo pipefail

xochitldir=remarkable:.local/share/remarkable/xochitl/

if [ $# -lt 1 ]; then
  echo "Transfer PDF/EPUB document(s) to a reMarkable tablet"
  echo "usage: $(basename "$0") path-to-file [path-to-file]..."
  exit 1
fi

tmpdir=$(mktemp -d)

cleanup() {
  rm -rf "${tmpdir}"
}
trap cleanup EXIT

for src in "$@"; do
  # detect extension + normalize
  fname="$(basename "$src")"
  ext="${fname##*.}"
  ext="${ext,,}"                       # lowercase
  base="${fname%.*}"

  case "$ext" in
    pdf)  filetype="pdf"  ;;
    epub) filetype="epub" ;;
    *)
      echo "Skipping '$src' (unsupported extension; only .pdf or .epub)."
      continue
      ;;
  esac

  uuid="$(uuidgen)"

  # copy the original file with matching extension
  cp "$src" "${tmpdir}/${uuid}.${filetype}"

  # metadata
  cat > "${tmpdir}/${uuid}.metadata" <<EOF
{
  "deleted": false,
  "lastModified": "$(date +%s)000",
  "metadatamodified": false,
  "modified": false,
  "parent": "",
  "pinned": false,
  "synced": false,
  "type": "DocumentType",
  "version": 1,
  "visibleName": "${base}"
}
EOF

  # content (fileType is the key bit for EPUB)
  cat > "${tmpdir}/${uuid}.content" <<EOF
{
  "extraMetadata": {},
  "fileType": "${filetype}",
  "fontName": "",
  "lastOpenedPage": 0,
  "lineHeight": -1,
  "margins": 100,
  "pageCount": 1,
  "textScale": 1,
  "transform": {
    "m11": 1, "m12": 1, "m13": 1,
    "m21": 1, "m22": 1, "m23": 1,
    "m31": 1, "m32": 1, "m33": 1
  }
}
EOF

  # required dirs (safe even if not strictly used)
  mkdir -p "${tmpdir}/${uuid}.cache" \
           "${tmpdir}/${uuid}.highlights" \
           "${tmpdir}/${uuid}.thumbnails"

  # optional thumbnail: only try for PDFs (ImageMagick can’t render EPUBs)
  if [ "$filetype" = "pdf" ]; then
    if command -v convert >/dev/null 2>&1; then
      convert -limit thread 1 -density 300 "$src"'[0]' \
        -colorspace Gray -separate -average -shave 5%x5% -resize 280x374 \
        "${tmpdir}/${uuid}.thumbnails/0.jpg" || true
    fi
  fi

  echo "Transferring '$src' as $uuid"
  scp -r "${tmpdir}/"* ${xochitldir}
  rm -rf "${tmpdir:?}/"*
done

echo "All done. Restarting xochitl to rescan files…"
ssh remarkable systemctl restart xochitl
