#!/usr/bin/env bash

if [ -z $2 ]; then
	printf "usage: hls-encode input.video name\n"
	exit 1
fi

mkdir -p $2

pushd "$2"
#
  #-map "[v1out]" -c:v:0 libx264 -b:v:0 5000k -maxrate:v:0 5350k -bufsize:v:0 7500k -pix_fmt yuv420p -profile:v:0 baseline \
  #
  #-map a:0 -c:a aac -b:a:3 96k -ac 2 \

  # "[0:v]split=3[v1][v2][v3]; \
  #  [v1]scale=w=1920:h=1080[v1out]; \
  #  [v2]scale=w=1280:h=720[v2out]; \
  #  [v3]scale=w=854:h=480[v3out];" \
  
  #-filter_complex \
  #  "[0:v]split=3[v2][v3][v4]; \
  #   [v2]scale=w=720:h=720[v2out]; \
  #   [v3]scale=w=480:h=480[v3out]; \
  #   [v4]scale=w=240:h=240[v4out];" \

  #-filter_complex \
  #  "[0:v]split=3[v2][v3][v4]; \
  #   [v2]scale=w=1080:h=1920[v2out]; \
  #   [v3]scale=w=720:h=1280[v3out]; \
  #   [v4]scale=w=240:h=426[v4out];" \

  #-filter_complex \
  #  "[0:v]split=2[v2][v3]; \
  #   [v2]scale=w=720:h=1280[v2out]; \
  #   [v3]scale=w=426:h=240[v3out];" \

ffmpeg -i "../$1" \
  -filter_complex \
     "[0:v]split=3[v1][v2][v3]; \
      [v1]scale=w=1080:h=1080[v1out]; \
      [v2]scale=w=720:h=720[v2out]; \
      [v3]scale=w=480:h=480[v3out];" \
  -map "[v1out]" -c:v:1 libx264 -b:v:1 3000k -maxrate:v:1 3200k -bufsize:v:1 3600k -pix_fmt yuv420p -profile:v:1 baseline \
  -map "[v2out]" -c:v:2 libx264 -b:v:2 1000k -maxrate:v:2 1200k -bufsize:v:2 1800k -pix_fmt yuv420p -profile:v:2 baseline \
  -map "[v3out]" -c:v:3 libx264 -b:v:3 1000k -maxrate:v:3 600k -bufsize:v:2 900k -pix_fmt yuv420p -profile:v:3 baseline \
  -map a:0 -c:a aac -b:a:0 192k -ac 2 \
  -map a:0 -c:a aac -b:a:1 128k -ac 2 \
  -map a:0 -c:a aac -b:a:2 128k -ac 2 \
  -f hls \
  -hls_time 10 \
  -hls_playlist_type vod \
  -hls_flags independent_segments \
  -hls_segment_type mpegts \
  -hls_segment_filename "stream_%v/data%03d.ts" \
  -master_pl_name "master.m3u8" \
  -var_stream_map "v:0,a:0 v:1,a:1 v:2,a:2" \
  stream_%v/playlist.m3u8

  #-var_stream_map "v:0,a:0 v:1,a:1 v:2,a:2 v:3,a:3" \
popd
