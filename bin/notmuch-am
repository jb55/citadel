#!/usr/bin/env bash

set -eo pipefail

# ###
#
# Generated by argbash.io
#
# ###

die()
{
    local _ret="${2:-1}"
    test "${_PRINT_HELP:-no}" = yes && print_help >&2
    echo "$1" >&2
    exit "${_ret}"
}


begins_with_short_option()
{
    local first_option all_short_options='h'
    first_option="${1:0:1}"
    test "$all_short_options" = "${all_short_options/$first_option/}" && return 1 || return 0
}

# THE DEFAULTS INITIALIZATION - POSITIONALS
_positionals=()
# THE DEFAULTS INITIALIZATION - OPTIONALS
_arg_am="off"
_arg_3="off"
_arg_amsignoff="off"
_arg_fuzzy="off"
_arg_fuzzy_search=""


print_help()
{
    printf '%s\n' "Use b4 to apply a patchset from a thread."
    printf 'Usage: %s [-h|--help] [--(no-)am] <thread-id>\n' "$0"
    printf '\t%s\n' "<thread-id>: The notmuch thread id of the thread to apply"
    printf '\t%s\n' "--am, --no-am: Call git-am instead of generating a mbox file (off by default)"
    printf '\t%s\n' "-3: Call git-am with -3 (off by default, only effective with --am)"
    printf '\t%s\n' "-s, --signoff: Call git-am with --signoff (off by default, only effective with --am)"
    printf '\t%s\n' "-f, --fuzzy <search>: Use fzf to interactively select the thread for the patchset to apply, pass <search> to notmuch-search, if given"
    printf '\t%s\n' "-h, --help: Prints help"
    printf %s "\

Example

  $ notmuch-am thread:000000000001b70e
  Analyzing 6 messages in the thread
  ---
  Writing ./20210206_jb55_b4_init_at_0_6_2.mbx
    [PATCH] b4: init at 0.6.2
      + Reviewed-by: Xinglu Chen <public@yoctocell.xyz> (âœ“ DKIM/yoctocell.xyz)
      + Reviewed-by: Matthias Beyer <mail@beyermatthias.de>
"
}
parse_commandline()
{
    _positionals_count=0
    while test $# -gt 0
    do
        _key="$1"
        case "$_key" in
            -h|--help)
                print_help
                exit 0
                ;;
            -h*)
                print_help
                exit 0
                ;;
            --no-am|--am)
                _arg_am="on"
                test "${1:0:5}" = "--no-" && _arg_am="off"
                ;;
            -3)
                _arg_3="on"
                ;;
            -s|--signoff)
                _arg_amsignoff="on"
                ;;
            -l|--add-link)
                _arg_b4addlink="on"
                ;;
            -f|--fuzzy)
                _arg_fuzzy="on"
                _arg_fuzzy_search="${2:-*}"
                ;;
            *)
                _last_positional="$1"
                _positionals+=("$_last_positional")
                _positionals_count=$((_positionals_count + 1))
                ;;
        esac
        shift
    done
}


handle_passed_args_count()
{
    local _required_args_string="'thread-id'"
    if [[ "${_positionals_count}" -ge 2 ]] && [[ "$_arg_fuzzy" == "off" ]]; then
        _PRINT_HELP=yes die "FATAL ERROR: Not enough positional arguments - we require exactly 1 (namely: $_required_args_string), but got only ${_positionals_count}." 1
    fi
    if [[ "${_positionals_count}" -lt 1 ]] && [[ "$_arg_fuzzy" == "off" ]]; then
        _PRINT_HELP=yes die "FATAL ERROR: There were spurious positional arguments --- we expect exactly 1 (namely: $_required_args_string), but got ${_positionals_count} (the last one was: '${_last_positional}')." 1
    fi
}


assign_positional_args()
{
    local _positional_name _shift_for=$1
    _positional_names="_arg_thread_id "

    shift "$_shift_for"
    for _positional_name in ${_positional_names}
    do
        test $# -gt 0 || break
        eval "$_positional_name=\${1}" || die "Error during argument parsing, possibly an Argbash bug." 1
        shift
    done
}

parse_commandline "$@"
handle_passed_args_count
assign_positional_args 1 "${_positionals[@]}"

# ###
#
# / Generated by argbash.io
#
# ###

B4AM_ARGS=${B4AM_ARGS:-""}

main () {
    mbox=$(mktemp)
    notmuch show --format=mbox "$1" > "$mbox"
    msgid=$(grep -i ^message-id "$mbox" | cut -d" " -f2 | head -n1)

    if [[ "$_arg_b4addlink" == "on" ]]; then
        B4AM_ARGS+=" --add-link"
    fi

    B4AM_ARGS+=" $msgid"

    if [[ "$_arg_am" == "on" ]]; then
        AM_ARGS="$NOTMUCH_AM_ARGS"
        if [[ "$_arg_3" == "on" ]]; then
            AM_ARGS+=" -3"
        fi
        if [[ "$_arg_amsignoff" == "on" ]]; then
            AM_ARGS+=" --signoff"
        fi

        b4 am $B4AM_ARGS -m "$mbox" -o - | git am $AM_ARGS
    else
        b4 am $B4AM_ARGS -m "$mbox"
    fi

    rm -f "$mbox"
}

thread_id="$_arg_thread_id"

if [[ "$_arg_fuzzy" == "on" ]]; then
    preview_script='echo {} | sed "s,\t.*,,; s,^,thread:," | xargs notmuch search --output=files --format=text | xargs grep -ihE "^Subject" | sort'

    user_email="$(git config user.email)"

    thread_id=$(notmuch search --output=summary --format=json "$_arg_fuzzy_search" | \
        jq -rcC '.[] | [.thread,.date_relative,.subject,.authors] | @tsv' | \
        fzf -m --preview "$preview_script" | \
        sed 's,\t.*,,; s,^,thread:,')
fi

[ -n "$1" ] || usage && main "$thread_id"

